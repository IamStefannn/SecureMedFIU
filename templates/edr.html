<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>EDR Panel - SecureMed</title>
<style>
body{font-family:Arial;background:#f4f6fb;padding:20px;}
h1{color:#333;}
.card{background:white;padding:16px;border-radius:10px;margin-top:16px;box-shadow:0 6px 20px rgba(0,0,0,.06);}
table{width:100%;border-collapse:collapse;}
th,td{padding:10px;border-bottom:1px solid #eee;}
th{background:#667eea;color:white;}
.badge{padding:6px 8px;border-radius:6px;color:white;}
.Critical{background:#e74c3c;}
.High{background:#e67e22;}
.Medium{background:#f1c40f;color:black;}
.Low{background:#27ae60;}
button{padding:6px 10px;border:none;border-radius:6px;background:#667eea;color:white;cursor:pointer;margin:3px;}
.status-light{display:inline-block;width:14px;height:14px;border-radius:50%;margin-right:6px;background:#bbb;}
.active{background:#27ae60;}
a.hipaa-link{color:#2980b9;text-decoration:none;}
a.hipaa-link:hover{text-decoration:underline;}
.alert-banner{background:#fee2e2;border-left:4px solid #ef4444;padding:16px;margin:16px 0;border-radius:8px;}
.alert-banner h3{margin:0 0 8px 0;color:#991b1b;}
.status-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;}
.fix-btn{background:#10b981;padding:4px 12px;border-radius:6px;font-size:12px;}
.fix-btn:hover{background:#059669;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;}
.modal.show{display:flex;}
.modal-content{background:white;padding:32px;border-radius:12px;max-width:700px;width:90%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 50px rgba(0,0,0,0.3);}
.modal-content::-webkit-scrollbar{width:10px;}
.modal-content::-webkit-scrollbar-track{background:#f1f1f1;border-radius:10px;}
.modal-content::-webkit-scrollbar-thumb{background:#667eea;border-radius:10px;}
.modal-content::-webkit-scrollbar-thumb:hover{background:#5568d3;}
.fix-step{background:#f9fafb;padding:12px;border-radius:8px;margin:8px 0;border-left:4px solid #667eea;}
</style>
</head>
<body>
<h1>üõ°Ô∏è Endpoint Detection & Response (EDR)</h1>
<a href="/dashboard"><button>‚¨Ö Back to Dashboard</button></a>
<button style="background:#95a5a6;" onclick="resetSystem()">üîÑ Reset System State</button>

<div class="card">
  <h3>System Hardening Status</h3>
  <div class="status-row">
    <span><span class="status-light" id="httpsLight"></span>HTTPS / TLS 1.3 <span id="httpsLabel">(disabled)</span></span>
    <button class="fix-btn" id="httpsBtn" onclick="quickFixHardening('https')">üîß Enable</button>
  </div>
  <div class="status-row">
    <span><span class="status-light" id="encLight"></span>AES-256 Encryption <span id="encLabel">(disabled)</span></span>
    <button class="fix-btn" id="encBtn" onclick="quickFixHardening('encryption')">üîß Upgrade</button>
  </div>
  <div class="status-row">
    <span><span class="status-light" id="apiLight"></span>OAuth2 API Protection <span id="apiLabel">(disabled)</span></span>
    <button class="fix-btn" id="apiBtn" onclick="quickFixHardening('api')">üîß Protect</button>
  </div>
  <div class="status-row">
    <span><span class="status-light" id="sqlLight"></span>Parameterized Queries <span id="sqlLabel">(disabled)</span></span>
    <button class="fix-btn" id="sqlBtn" onclick="quickFixHardening('sql')">üîß Implement</button>
  </div>
  <div class="status-row">
    <span><span class="status-light" id="depLight"></span>Dependencies Up-to-Date <span id="depLabel">(outdated)</span></span>
    <button class="fix-btn" id="depBtn" onclick="quickFixHardening('dependencies')">üîß Update</button>
  </div>
</div>

<div id="assignment-violations-section"></div>

<div class="card" id="hipaa-log">
  <h3>üìú All HIPAA Violations & Assignment Errors</h3>
  <table id="violation-table">
    <thead><tr><th>Time</th><th>Nurse</th><th>Type</th><th>Violation</th><th>HIPAA</th><th>Action</th></tr></thead>
    <tbody><tr><td colspan="6">Loading...</td></tr></tbody>
  </table>
</div>

<div class="card">
  <h3>üîß Technical Vulnerabilities</h3>
  <table id="edr-table">
    <thead><tr>
      <th>ID</th><th>Type</th><th>Severity</th><th>HIPAA</th>
      <th>Cause</th><th>Recommendation</th>
      <th>Status</th><th>Action</th>
    </tr></thead>
    <tbody><tr><td colspan="8">Loading...</td></tr></tbody>
  </table>
</div>

<!-- Fix Instructions Modal -->
<div id="fixModal" class="modal">
  <div class="modal-content">
    <h3 id="fix-title">Remediation Instructions</h3>
    <div id="fix-instructions"></div>
    <div style="margin-top:24px;display:flex;gap:12px;">
      <button style="flex:1;padding:12px;background:#10b981;color:white" onclick="applyDetailedFix()">‚úÖ Mark as Fixed</button>
      <button style="flex:1;padding:12px;background:#ef4444;color:white" onclick="closeFixModal()">‚ùå Close</button>
    </div>
  </div>
</div>

<script>
const role="{{ session.get('role','') }}";
let currentFixId = null;
let currentFixType = null;

const hardeningMap = {
  'https': {vulnType: 'No HTTPS', light: 'httpsLight', label: 'httpsLabel', btn: 'httpsBtn'},
  'encryption': {vulnType: 'Weak Encryption', light: 'encLight', label: 'encLabel', btn: 'encBtn'},
  'api': {vulnType: 'Unauthorized API Access', light: 'apiLight', label: 'apiLabel', btn: 'apiBtn'},
  'sql': {vulnType: 'SQL Injection', light: 'sqlLight', label: 'sqlLabel', btn: 'sqlBtn'},
  'dependencies': {vulnType: 'Insecure Dependencies', light: 'depLight', label: 'depLabel', btn: 'depBtn'}
};

const fixInstructions = {
  "No HTTPS": {
    title: "Enable HTTPS/TLS 1.3",
    steps: [
      "1. Generate SSL certificate: <code>openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365</code>",
      "2. Update Flask config: <code>app.run(ssl_context=('cert.pem', 'key.pem'))</code>",
      "3. Force HTTPS redirect in nginx/Apache config",
      "4. Add HSTS header: <code>add_header Strict-Transport-Security \"max-age=31536000\"</code>",
      "5. Test with: <code>curl -I https://securemed.com</code>"
    ]
  },
  "Weak Encryption": {
    title: "Upgrade to AES-256-GCM",
    steps: [
      "1. Install cryptography library: <code>pip install cryptography</code>",
      "2. Generate new Fernet key: <code>python -c 'from cryptography.fernet import Fernet; print(Fernet.generate_key())'</code>",
      "3. Update encryption in backend.py: <code>cipher = Fernet(KEY)</code>",
      "4. Re-encrypt existing data with migration script",
      "5. Store key in environment variable or AWS KMS"
    ]
  },
  "Unauthorized API Access": {
    title: "Add OAuth2/API Key Protection",
    steps: [
      "1. Install Flask-JWT-Extended: <code>pip install flask-jwt-extended</code>",
      "2. Add JWT decorator to API routes: <code>@jwt_required()</code>",
      "3. Generate API keys for authorized services",
      "4. Implement rate limiting: <code>@limiter.limit(\"100/hour\")</code>",
      "5. Log all API access attempts to audit trail"
    ]
  },
  "SQL Injection": {
    title: "Use Parameterized Queries",
    steps: [
      "1. Replace string concatenation with placeholders",
      "2. Use: <code>cursor.execute('SELECT * FROM users WHERE id=?', (user_id,))</code>",
      "3. Never use: <code>cursor.execute(f'SELECT * FROM users WHERE id={user_id}')</code>",
      "4. Validate all user inputs with regex/allowlists",
      "5. Run SQLMap scan to verify: <code>sqlmap -u http://securemed.com/api/patients</code>"
    ]
  },
  "Insecure Dependencies": {
    title: "Update Dependencies & Run SBOM",
    steps: [
      "1. Check outdated packages: <code>pip list --outdated</code>",
      "2. Update all: <code>pip install --upgrade -r requirements.txt</code>",
      "3. Generate SBOM: <code>pip-audit --format json > sbom.json</code>",
      "4. Scan for vulnerabilities: <code>safety check</code>",
      "5. Set up Dependabot for automated security updates"
    ]
  },
  "RANSOMWARE ATTACK": {
    title: "Ransomware Incident Response Procedure",
    steps: [
      "<strong style='color:#dc2626;'>‚ö†Ô∏è DO NOT PAY THE RANSOM</strong>",
      "<strong>Phase 1: Immediate Containment (0-1 hour)</strong>",
      "1. Disconnect affected systems from network immediately",
      "2. Isolate backup systems to prevent encryption spread",
      "3. Notify incident response team and security officer",
      "4. Document all actions taken (screenshots, logs, timestamps)",
      "<strong>Phase 2: Investigation (1-24 hours)</strong>",
      "5. Identify ransomware variant using hash analysis",
      "6. Determine entry point (phishing email, RDP, vulnerability)",
      "7. Assess scope: Number of systems and records affected",
      "8. Check for data exfiltration before encryption",
      "<strong>Phase 3: Recovery (24-72 hours)</strong>",
      "9. Restore from clean backups (test for integrity first)",
      "10. Rebuild compromised systems from scratch",
      "11. Reset all passwords and revoke compromised credentials",
      "12. Apply security patches that prevented the attack",
      "<strong>Phase 4: HIPAA Compliance (within 60 days)</strong>",
      "13. Notify HHS within 60 days if >500 records affected",
      "14. Notify affected individuals within 60 days",
      "15. Notify media if breach affects >500 individuals in same state",
      "16. Document: breach discovery, response actions, affected PHI",
      "<strong>Phase 5: Prevention</strong>",
      "17. Implement MFA on all remote access",
      "18. Deploy EDR (Endpoint Detection & Response) solution",
      "19. Conduct security awareness training",
      "20. Schedule penetration testing quarterly"
    ]
  },
  "INSIDER DATA THEFT": {
    title: "Insider Threat Response Procedure",
    steps: [
      "<strong style='color:#dc2626;'>‚ö†Ô∏è CRITICAL: Preserve evidence for legal action</strong>",
      "<strong>Phase 1: Immediate Action (0-2 hours)</strong>",
      "1. Disable employee's user account immediately",
      "2. Revoke all access credentials (VPN, building access, systems)",
      "3. Remotely wipe company devices if possible",
      "4. Preserve audit logs showing access history",
      "5. Secure employee's workstation - do not power off",
      "<strong>Phase 2: Forensic Investigation (2-48 hours)</strong>",
      "6. Review access logs to determine what PHI was accessed",
      "7. Check email logs for data sent to personal/external addresses",
      "8. Analyze USB usage logs and file transfer history",
      "9. Interview IT staff about unusual system access patterns",
      "10. Document chain of custody for all evidence",
      "<strong>Phase 3: Containment & Assessment</strong>",
      "11. Identify all patients whose PHI was compromised",
      "12. Determine if data was shared with third parties",
      "13. Assess risk of identity theft or fraud",
      "14. Review employee's access history for past 90 days",
      "<strong>Phase 4: Legal & HIPAA Requirements</strong>",
      "15. Contact legal counsel immediately",
      "16. File police report for theft of confidential information",
      "17. Notify HHS within 60 days",
      "18. Provide breach notification to affected patients",
      "19. Offer credit monitoring if SSN/financial data exposed",
      "<strong>Phase 5: Prevention</strong>",
      "20. Implement Data Loss Prevention (DLP) software",
      "21. Monitor file downloads and USB usage",
      "22. Require manager approval for bulk data exports",
      "23. Conduct background checks for all employees",
      "24. Implement User Behavior Analytics (UBA)"
    ]
  },
  "PHISHING ATTACK - CREDENTIALS COMPROMISED": {
    title: "Phishing Incident Response Procedure",
    steps: [
      "<strong style='color:#dc2626;'>‚ö†Ô∏è URGENT: Prevent further unauthorized access</strong>",
      "<strong>Phase 1: Immediate Lockdown (0-30 minutes)</strong>",
      "1. Force password reset for all compromised accounts",
      "2. Enable MFA immediately on all accounts",
      "3. Revoke all active sessions for affected users",
      "4. Block suspicious IP addresses in firewall",
      "5. Alert all staff about active phishing campaign",
      "<strong>Phase 2: Investigation (30 min - 4 hours)</strong>",
      "6. Review audit logs for unauthorized access",
      "7. Check what PHI was accessed during compromise window",
      "8. Identify all employees who clicked phishing link",
      "9. Analyze phishing email headers and payload",
      "10. Report to FBI IC3 (Internet Crime Complaint Center)",
      "<strong>Phase 3: Remediation (4-24 hours)</strong>",
      "11. Scan all systems for malware/backdoors",
      "12. Reset passwords for ALL users (not just victims)",
      "13. Implement email security (SPF, DKIM, DMARC)",
      "14. Deploy anti-phishing email filters",
      "15. Monitor dark web for leaked credentials",
      "<strong>Phase 4: HIPAA Compliance</strong>",
      "16. Document number of patient records accessed",
      "17. Notify HHS if breach threshold met",
      "18. Notify affected patients of potential compromise",
      "19. Provide guidance on monitoring medical records",
      "<strong>Phase 5: Training & Prevention</strong>",
      "20. Conduct mandatory phishing awareness training",
      "21. Run quarterly phishing simulations",
      "22. Implement email banner warnings for external emails",
      "23. Deploy FIDO2 hardware keys for high-privilege accounts"
    ]
  },
  "DATABASE EXPOSED TO INTERNET": {
    title: "Public Data Exposure Response",
    steps: [
      "<strong style='color:#dc2626;'>‚ö†Ô∏è CRITICAL: Data may already be harvested</strong>",
      "<strong>Phase 1: Immediate Containment (0-15 minutes)</strong>",
      "1. Take database offline immediately",
      "2. Block all public IP access at firewall level",
      "3. Enable authentication and require VPN for access",
      "4. Change all database passwords immediately",
      "<strong>Phase 2: Damage Assessment (15 min - 2 hours)</strong>",
      "5. Review web server logs for database access",
      "6. Check search engine caches (Google, Bing) for indexed data",
      "7. Request immediate delisting from search engines",
      "8. Scan dark web marketplaces for leaked data",
      "9. Determine exposure duration (logs, DNS records)",
      "<strong>Phase 3: Impact Analysis</strong>",
      "10. Identify all PHI that was publicly accessible",
      "11. Document fields exposed (SSN, diagnosis, treatment, etc.)",
      "12. Estimate number of patient records exposed",
      "13. Assess if data has appeared on public forums",
      "<strong>Phase 4: HIPAA Breach Notification (60 days)</strong>",
      "14. Notify HHS within 60 days - this is a major breach",
      "15. Notify ALL affected patients individually",
      "16. Prepare public statement if media notification required",
      "17. Offer free credit monitoring and identity protection",
      "18. Set up dedicated breach hotline for patient questions",
      "<strong>Phase 5: Security Hardening</strong>",
      "19. Implement network segmentation (database on private subnet)",
      "20. Deploy Web Application Firewall (WAF)",
      "21. Conduct external penetration test",
      "22. Implement database activity monitoring",
      "23. Encrypt database at rest with TDE (Transparent Data Encryption)"
    ]
  },
  "LAPTOP THEFT WITH UNENCRYPTED PHI": {
    title: "Physical Device Theft Response",
    steps: [
      "<strong style='color:#dc2626;'>‚ö†Ô∏è CRITICAL: Unencrypted PHI is immediately compromised</strong>",
      "<strong>Phase 1: Immediate Response (0-2 hours)</strong>",
      "1. File police report immediately (required for HIPAA)",
      "2. Attempt remote wipe if device has MDM (Mobile Device Management)",
      "3. Change passwords for any accounts accessed from device",
      "4. Revoke device certificates and VPN credentials",
      "5. Notify insurance carrier (cyber liability policy)",
      "<strong>Phase 2: Impact Assessment (2-8 hours)</strong>",
      "6. Identify all PHI stored on stolen device",
      "7. Review recent file access logs from device",
      "8. Determine if backups contain same data",
      "9. Check if device had remote access to additional systems",
      "10. Document when/where theft occurred",
      "<strong>Phase 3: HIPAA Breach Notification</strong>",
      "11. This is a REPORTABLE BREACH - unencrypted PHI",
      "12. Notify HHS within 60 days",
      "13. Notify all patients whose PHI was on device",
      "14. Notify local media if >500 residents of one state affected",
      "15. Provide toll-free number for patient inquiries",
      "<strong>Phase 4: Risk Mitigation</strong>",
      "16. Offer credit monitoring to affected patients",
      "17. Monitor for identity theft or medical fraud",
      "18. Flag accounts in medical billing systems",
      "19. Alert insurance companies of potential fraud",
      "<strong>Phase 5: Prevention (MANDATORY)</strong>",
      "20. <strong>Encrypt ALL devices with BitLocker/FileVault</strong>",
      "21. Implement MDM for remote wipe capability",
      "22. Prohibit storing PHI on local devices",
      "23. Require VPN + cloud storage only",
      "24. Update HIPAA policies: encryption is MANDATORY",
      "25. Conduct quarterly device encryption audits"
    ]
  }
};

const hipaaLinks={
  // Administrative Safeguards (164.308)
  "164.308(a)(1)(ii)(A)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.308#p-164.308(a)(1)(ii)(A)",
  "164.308(a)(1)(ii)(C)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.308#p-164.308(a)(1)(ii)(C)",
  "164.308(a)(2)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.308#p-164.308(a)(2)",
  "164.308(a)(3)(i)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.308#p-164.308(a)(3)(i)",
  "164.308(a)(3)(ii)(B)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.308#p-164.308(a)(3)(ii)(B)",
  "164.308(a)(5)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.308#p-164.308(a)(5)",
  "164.308(a)(5)(i)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.308#p-164.308(a)(5)(i)",
  "164.308(a)(6)(i)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.308#p-164.308(a)(6)(i)",
  "164.308(a)(7)(i)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.308#p-164.308(a)(7)(i)",
  "164.308(b)(1)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.308#p-164.308(b)(1)",

  // Physical Safeguards (164.310)
  "164.310(a)(1)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.310#p-164.310(a)(1)",
  "164.310(a)(2)(iii)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.310#p-164.310(a)(2)(iii)",
  "164.310(b)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.310#p-164.310(b)",
  "164.310(d)(1)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.310#p-164.310(d)(1)",
  "164.310(d)(2)(i)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.310#p-164.310(d)(2)(i)",

  // Technical Safeguards (164.312)
  "164.312(a)(1)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.312#p-164.312(a)(1)",
  "164.312(a)(2)(i)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.312#p-164.312(a)(2)(i)",
  "164.312(a)(2)(iii)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.312#p-164.312(a)(2)(iii)",
  "164.312(a)(2)(iv)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.312#p-164.312(a)(2)(iv)",
  "164.312(b)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.312#p-164.312(b)",
  "164.312(c)(1)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.312#p-164.312(c)(1)",
  "164.312(d)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.312#p-164.312(d)",
  "164.312(e)(1)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.312#p-164.312(e)(1)",

  // Policies and Procedures (164.316)
  "164.316(a)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.316#p-164.316(a)",
  "164.316(b)(2)(iii)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-C/section-164.316#p-164.316(b)(2)(iii)",

  // Privacy Rule (164.502-164.528)
  "164.502(b)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-E/section-164.502#p-164.502(b)",
  "164.508(c)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-E/section-164.508#p-164.508(c)",
  "164.520(a)":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-E/section-164.520#p-164.520(a)",
  "164.526":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-E/section-164.526",
  "164.528":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-E/section-164.528",

  // Breach Notification Rule (164.400-164.414)
  "164.402":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-D/section-164.402",
  "164.408":"https://www.ecfr.gov/current/title-45/subtitle-A/subchapter-C/part-164/subpart-D/section-164.408"
};

let allVulns = [];

async function loadEDR(){
  const r=await fetch('/api/edr_data');
  const data=await r.json();
  allVulns = data;

  const techVulns = data.filter(v=>v.source==='scanner' || v.source==='breach_simulation' || v.source==='training_simulator');
  const nurseViolations = data.filter(v=>v.source==='nurse_assignment' || v.source==='nurse_training' || v.source==='nurse_violation' || v.source==='hipaa_compliance');

  // Show breach alert banner
  const breachIncidents = data.filter(v=>v.source==='breach_simulation' && v.status==='Unresolved');
  const banner = document.getElementById('assignment-violations-section');

  let bannerHTML = '';
  if(breachIncidents.length > 0){
    bannerHTML += `
      <div class="alert-banner" style="background:#fee2e2;border-left:4px solid #dc2626;">
        <h3>üö® ${breachIncidents.length} ACTIVE DATA BREACH INCIDENT${breachIncidents.length>1?'S':''}</h3>
        <p><strong>CRITICAL:</strong> Data breach requires immediate response! Review in Technical Vulnerabilities table below.</p>
      </div>
    `;
  }

  if(nurseViolations.length > 0){
    const unresolvedCount = nurseViolations.filter(v=>v.status==='Unresolved').length;
    bannerHTML += `
      <div class="alert-banner">
        <h3>‚ö†Ô∏è ${unresolvedCount} Unresolved Nurse Violations Detected!</h3>
        <p>Nurses have made errors completing assignments. Review violations below and provide retraining.</p>
      </div>
    `;
  }

  banner.innerHTML = bannerHTML;
  
  const violTb=document.querySelector('#violation-table tbody');
  if(!nurseViolations.length){
    violTb.innerHTML='<tr><td colspan="6" style="text-align:center;padding:20px">No nurse violations logged</td></tr>';
  } else {
    violTb.innerHTML='';
    nurseViolations.forEach(v=>{
      const link=hipaaLinks[v.hipaa_section]||'#';
      const actionBtn = (role==='admin' && v.status==='Unresolved') ? 
        `<button style="background:#27ae60;" onclick="quickFix(${v.id})">Quick Fix</button>` : 
        (v.status==='Resolved' ? '‚úÖ Resolved' : 'üëÄ View Only');
      
      violTb.innerHTML+=`<tr style="background:${v.status==='Unresolved'?'#fef2f2':'inherit'}">
        <td>${v.timestamp}</td>
        <td><strong>${v.nurse_username}</strong></td>
        <td>${v.source.replace('nurse_','').toUpperCase()}</td>
        <td>${v.details}</td>
        <td><a href="${link}" class="hipaa-link" target="_blank">${v.hipaa_section||''}</a></td>
        <td>${actionBtn}</td>
      </tr>`;
    });
  }
  
  const techTb=document.querySelector('#edr-table tbody');
  if(!techVulns.length){
    techTb.innerHTML='<tr><td colspan="8" style="text-align:center;padding:20px">No technical vulnerabilities or breach incidents</td></tr>';
  } else {
    techTb.innerHTML='';
    techVulns.forEach(v=>{
      const link=hipaaLinks[v.hipaa_section]||'#';

      // Special handling for breach simulations
      let act;
      if(role==='admin' && v.status==='Unresolved'){
        if(v.source==='breach_simulation' || v.source==='training_simulator'){
          act = `<button style="background:#27ae60;padding:8px 12px;border:none;border-radius:4px;color:white;cursor:pointer;margin-right:4px;" onclick="quickResolve(${v.id})">‚úÖ Resolve</button>
                 <button style="background:#3498db;padding:8px 12px;border:none;border-radius:4px;color:white;cursor:pointer;" onclick="showFixModal(${v.id},'${v.type.replace(/'/g,"")}')">üìñ View</button>`;
        } else {
          act = `<button style="background:#3498db;" onclick="showFixModal(${v.id},'${v.type.replace(/'/g,"")}')">üìñ View Fix</button>`;
        }
      } else {
        act = v.status==='Resolved' ? '‚úÖ Resolved' : 'üëÄ View Only';
      }

      const rowBg = v.source==='breach_simulation' && v.status==='Unresolved' ? 'background:#fff5f5;border-left:4px solid #dc2626;' : '';

      techTb.innerHTML+=`<tr style="${rowBg}">
        <td>${v.id}</td><td><strong>${v.type}</strong></td>
        <td><span class="badge ${v.severity}">${v.severity}</span></td>
        <td><a href="${link}" target="_blank">${v.hipaa_section||''}</a></td>
        <td>${v.details}</td><td>${v.recommendation}</td>
        <td>${v.status}</td><td>${act}</td>
      </tr>`;
    });
  }
  
  // Update button visibility
  updateHardeningButtons();
}

function updateHardeningButtons(){
  for(const [key, config] of Object.entries(hardeningMap)){
    const vuln = allVulns.find(v => v.type === config.vulnType && v.source === 'scanner');
    const btn = document.getElementById(config.btn);
    if(vuln && vuln.status === 'Resolved'){
      btn.style.display = 'none';
    } else {
      btn.style.display = 'inline-block';
    }
  }
}

async function quickFixHardening(type){
  const config = hardeningMap[type];
  if(!config) return;
  
  // Find the vulnerability
  const vuln = allVulns.find(v => v.type === config.vulnType && v.source === 'scanner');
  if(!vuln){
    alert('Vulnerability not found in database. Please seed vulnerabilities first.');
    return;
  }
  
  // Show quick confirmation
  if(!confirm(`Apply quick fix for ${config.vulnType}?\n\nThis will:\n‚Ä¢ Turn status light green\n‚Ä¢ Mark vulnerability as resolved\n‚Ä¢ Update system hardening status`)){
    return;
  }
  
  // Update UI immediately
  document.getElementById(config.light).classList.add('active');
  document.getElementById(config.label).textContent = type === 'https' ? '(enabled)' : 
                                                       type === 'encryption' ? '(enabled)' :
                                                       type === 'api' ? '(protected)' :
                                                       type === 'sql' ? '(protected)' : '(patched)';
  document.getElementById(config.btn).style.display = 'none';
  
  // Mark as resolved in backend
  await fetch(`/api/audit/${vuln.id}/resolve`, {method:'POST'});
  
  alert(`‚úÖ ${config.vulnType} has been remediated!`);
  loadEDR();
}

function showFixModal(id, type){
  currentFixId = id;
  currentFixType = type;
  const instructions = fixInstructions[type];
  
  if(!instructions){
    alert('No fix instructions available for this vulnerability type.');
    return;
  }
  
  document.getElementById('fix-title').textContent = instructions.title;
  
  let html = '<div style="background:#e0e7ff;padding:12px;border-radius:8px;margin-bottom:16px;">';
  html += '<strong>üìö Technical Remediation Steps:</strong></div>';
  
  instructions.steps.forEach(step => {
    html += `<div class="fix-step">${step}</div>`;
  });
  
  html += '<p style="margin-top:16px;font-size:13px;color:#6b7280;">These are the actual technical steps to fix this vulnerability in production.</p>';
  
  document.getElementById('fix-instructions').innerHTML = html;
  document.getElementById('fixModal').classList.add('show');
}

function closeFixModal(){
  document.getElementById('fixModal').classList.remove('show');
  currentFixId = null;
  currentFixType = null;
}

async function applyDetailedFix(){
  if(!currentFixId || !currentFixType){
    return;
  }
  
  // Find the hardening config for this vuln type
  for(const [key, config] of Object.entries(hardeningMap)){
    if(config.vulnType === currentFixType){
      document.getElementById(config.light).classList.add('active');
      document.getElementById(config.label).textContent = key === 'https' ? '(enabled)' : 
                                                           key === 'encryption' ? '(enabled)' :
                                                           key === 'api' ? '(protected)' :
                                                           key === 'sql' ? '(protected)' : '(patched)';
      document.getElementById(config.btn).style.display = 'none';
      break;
    }
  }
  
  await fetch(`/api/audit/${currentFixId}/resolve`,{method:'POST'});
  alert(`‚úÖ ${currentFixType} has been remediated!`);
  closeFixModal();
  loadEDR();
}

async function quickFix(id){
  if(!confirm('Mark this violation as resolved? This simulates nurse retraining and policy updates.')){
    return;
  }
  await fetch(`/api/audit/${id}/resolve`,{method:'POST'});
  loadEDR();
  alert('‚úÖ Violation resolved. Nurse has been retrained.');
}

async function quickResolve(id){
  if(!confirm('Mark this breach/incident as resolved?\n\nThis indicates the incident has been:\n- Investigated\n- Contained\n- Remediated\n- Documented per HIPAA requirements')){
    return;
  }
  await fetch(`/api/audit/${id}/resolve`,{method:'POST'});
  loadEDR();
  alert('‚úÖ Breach incident resolved and documented!');
}

async function resetSystem(){
  if(!confirm('Reset all system states and mark all violations as unresolved?\n\nThis will prepare the system for another demo.')){
    return;
  }
  
  // Reset all lights
  for(const config of Object.values(hardeningMap)){
    document.getElementById(config.light).classList.remove('active');
    document.getElementById(config.label).textContent = '(disabled)';
    if(config.label === 'depLabel'){
      document.getElementById(config.label).textContent = '(outdated)';
    }
    document.getElementById(config.btn).style.display = 'inline-block';
  }
  
  await fetch('/api/audit/reset_all',{method:'POST'});
  alert('‚úÖ System state reset. Ready for next demo!');
  loadEDR();
}

loadEDR();
</script>
</body>
</html>