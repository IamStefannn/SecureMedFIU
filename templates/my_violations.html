<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My HIPAA Violations - SecureMed</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; }
.header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
.header h1 { font-size: 28px; font-weight: 700; }
.header p { opacity: 0.9; font-size: 14px; margin-top: 4px; }
.container { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
.btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 14px; }
.btn-primary { background: #667eea; color: white; }
.btn-primary:hover { background: #5568d3; transform: translateY(-2px); }
.btn-success { background: #10b981; color: white; }
.btn-success:hover { background: #059669; }
.btn-danger { background: #ef4444; color: white; }
.btn-danger:hover { background: #dc2626; }
.btn-warning { background: #f59e0b; color: white; }
.btn-warning:hover { background: #d97706; }
.btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }

.actions { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
.stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
.stat-label { color: #6b7280; font-size: 14px; margin-bottom: 8px; }
.stat-number { font-size: 32px; font-weight: 700; color: #1f2937; }

.card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 24px; }
.card h2 { font-size: 20px; color: #1f2937; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #e5e7eb; }

.violation-item { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; background: #fafafa; }
.violation-item.acknowledged { background: #d1fae5; border-color: #10b981; }
.violation-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
.violation-title { font-size: 18px; font-weight: 600; color: #1f2937; }
.violation-badges { display: flex; gap: 8px; align-items: center; }
.badge { padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; }
.badge-critical { background: #fee2e2; color: #991b1b; }
.badge-high { background: #fed7aa; color: #9a3412; }
.badge-medium { background: #fef3c7; color: #92400e; }
.badge-low { background: #d1fae5; color: #065f46; }
.badge-acknowledged { background: #10b981; color: white; }
.badge-overdue { background: #dc2626; color: white; animation: pulse 2s infinite; }
.badge-deadline { background: #3b82f6; color: white; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

.violation-details { margin-top: 12px; }
.detail-row { display: grid; grid-template-columns: 150px 1fr; gap: 12px; padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
.detail-row:last-child { border-bottom: none; }
.detail-label { font-weight: 600; color: #6b7280; }
.detail-value { color: #1f2937; }

.violation-actions { margin-top: 16px; display: flex; gap: 8px; }

.loading, .empty-state { text-align: center; padding: 40px; color: #6b7280; }

/* Loading Spinner Styles */
.spinner-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; }
.spinner { width: 50px; height: 50px; border: 4px solid #e5e7eb; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.spinner-text { color: #6b7280; font-size: 16px; font-weight: 500; }

/* Loading Overlay */
.loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; }
.loading-overlay .spinner-container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); min-height: auto; }
</style>
</head>
<body>
<div class="header">
  <div class="header-content">
    <div>
      <h1>üîí My HIPAA Violations</h1>
      <p>Review and acknowledge your compliance violations</p>
    </div>
    <button class="btn btn-danger" onclick="window.location.href='/logout'">Logout</button>
  </div>
</div>

<div class="container">
  <div class="actions">
    <button class="btn btn-primary" onclick="window.location.href='/user_dashboard'">‚¨Ö Back to Dashboard</button>
    <button class="btn btn-primary" onclick="loadViolations()">üîÑ Refresh</button>
    <button class="btn btn-success" id="generatePdfBtn" onclick="generateSignedPDF()">üìÑ Generate Signed PDF</button>
  </div>

  <div class="stats" id="stats">
    <div class="stat-card">
      <div class="stat-label">Total Violations</div>
      <div class="stat-number" id="totalCount">-</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Acknowledged</div>
      <div class="stat-number" id="acknowledgedCount">-</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Pending</div>
      <div class="stat-number" id="pendingCount">-</div>
    </div>
  </div>

  <div class="card">
    <h2>üìã My Violations</h2>
    <div id="violationsList">
      <div class="spinner-container">
        <div class="spinner"></div>
        <div class="spinner-text">Loading violations...</div>
      </div>
    </div>
  </div>
</div>

<div id="loadingOverlay" class="loading-overlay" style="display: none;">
  <div class="spinner-container">
    <div class="spinner"></div>
    <div class="spinner-text">Processing...</div>
  </div>
</div>

<script>
let allViolations = [];

function showLoading() {
  document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
  document.getElementById('loadingOverlay').style.display = 'none';
}

async function loadViolations() {
  try {
    const response = await fetch('/api/my_violations');
    if (!response.ok) {
      if (response.status === 403) {
        alert('Access denied. This page is for nurses only.');
        window.location.href = '/dashboard';
        return;
      }
      throw new Error('Failed to load violations');
    }
    allViolations = await response.json();
    renderViolations();
  } catch (error) {
    console.error('Error loading violations:', error);
    document.getElementById('violationsList').innerHTML =
      '<div class="empty-state">Error loading violations: ' + error.message + '</div>';
  }
}

function renderViolations() {
  const container = document.getElementById('violationsList');

  if (allViolations.length === 0) {
    container.innerHTML = '<div class="empty-state">üéâ No violations assigned to you!</div>';
    updateStats();
    return;
  }

  let html = '';
  allViolations.forEach((v, idx) => {
    const isAcknowledged = v.is_acknowledged;
    const acknowledgedClass = isAcknowledged ? 'acknowledged' : '';

    html += `
      <div class="violation-item ${acknowledgedClass}">
        <div class="violation-header">
          <div class="violation-title">Violation #${idx + 1}: ${v.type}</div>
          <div class="violation-badges">
            <span class="badge badge-${v.severity.toLowerCase()}">${v.severity}</span>
            ${isAcknowledged ? '<span class="badge badge-acknowledged">‚úì Acknowledged</span>' : ''}
            ${v.is_overdue && !isAcknowledged ? '<span class="badge badge-overdue">‚ö†Ô∏è OVERDUE</span>' : ''}
            ${v.remediation_deadline && !isAcknowledged ? `<span class="badge badge-deadline">üìÖ ${v.days_until_deadline} days left</span>` : ''}
          </div>
        </div>

        <div class="violation-details">
          <div class="detail-row">
            <div class="detail-label">Timestamp:</div>
            <div class="detail-value">${v.timestamp}</div>
          </div>
          ${v.remediation_deadline ? `
            <div class="detail-row">
              <div class="detail-label">Remediation Deadline:</div>
              <div class="detail-value" style="font-weight: 600; color: ${v.is_overdue ? '#dc2626' : '#1f2937'}">
                ${v.remediation_deadline} ${v.is_overdue ? '(OVERDUE!)' : `(${v.days_until_deadline} days remaining)`}
              </div>
            </div>
          ` : ''}
          <div class="detail-row">
            <div class="detail-label">HIPAA Section:</div>
            <div class="detail-value">${v.hipaa_section}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">What Happened:</div>
            <div class="detail-value">${v.details}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">How to Remediate:</div>
            <div class="detail-value">${v.recommendation}</div>
          </div>
          ${isAcknowledged ? `
            <div class="detail-row">
              <div class="detail-label">Acknowledged At:</div>
              <div class="detail-value">${v.acknowledged_at}</div>
            </div>
          ` : ''}
        </div>

        ${!isAcknowledged ? `
          <div class="violation-actions">
            <button class="btn btn-success" onclick="acknowledgeViolation(${v.id})">
              ‚úì Acknowledge & Sign Off
            </button>
          </div>
        ` : ''}
      </div>
    `;
  });

  container.innerHTML = html;
  updateStats();
}

function updateStats() {
  const total = allViolations.length;
  const acknowledged = allViolations.filter(v => v.is_acknowledged).length;
  const pending = total - acknowledged;

  document.getElementById('totalCount').textContent = total;
  document.getElementById('acknowledgedCount').textContent = acknowledged;
  document.getElementById('pendingCount').textContent = pending;

  // Enable/disable PDF button
  document.getElementById('generatePdfBtn').disabled = total === 0;
}

async function acknowledgeViolation(violationId) {
  if (!confirm('Are you sure you want to acknowledge this violation? This action confirms that you have reviewed and understood the violation.')) {
    return;
  }

  showLoading();
  try {
    const response = await fetch(`/api/violations/${violationId}/acknowledge`, {
      method: 'POST'
    });

    const result = await response.json();

    if (response.ok) {
      alert('‚úì Violation acknowledged successfully!');
      await loadViolations(); // Reload to show updated status
    } else {
      alert('Error: ' + result.error);
    }
  } catch (error) {
    alert('Error acknowledging violation: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function generateSignedPDF() {
  if (allViolations.length === 0) {
    alert('No violations to generate PDF for.');
    return;
  }

  const acknowledgedCount = allViolations.filter(v => v.is_acknowledged).length;
  const pendingCount = allViolations.length - acknowledgedCount;

  if (pendingCount > 0) {
    if (!confirm(`You have ${pendingCount} unacknowledged violation(s). Do you want to generate the PDF anyway?`)) {
      return;
    }
  }

  showLoading();
  try {
    const response = await fetch('/api/violations/generate_signed_pdf', {
      method: 'POST'
    });

    if (response.ok) {
      // Download the PDF
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `HIPAA_Violations_${new Date().toISOString().slice(0,10)}.pdf`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);

      alert('‚úì PDF generated successfully!');
    } else {
      const result = await response.json();
      alert('Error generating PDF: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    alert('Error generating PDF: ' + error.message);
  } finally {
    hideLoading();
  }
}

// Load violations on page load
loadViolations();
</script>
</body>
</html>
