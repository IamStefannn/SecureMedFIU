<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>HIPAA Training Simulator - SecureMed</title>
<style>
body{font-family:Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;min-height:100vh;}
.container{max-width:900px;margin:0 auto;}
h1{color:white;text-align:center;margin-bottom:10px;}
.subtitle{color:#e0e7ff;text-align:center;margin-bottom:30px;font-size:14px;}
button{padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;transition:all 0.3s;}
.btn-primary{background:#4ade80;color:white;} .btn-primary:hover{background:#22c55e;}
.btn-danger{background:#ef4444;color:white;} .btn-danger:hover{background:#dc2626;}
.btn-secondary{background:#6b7280;color:white;margin-left:10px;} .btn-secondary:hover{background:#4b5563;}
.card{background:white;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.2);padding:24px;margin-bottom:20px;}
.scenario{border-left:4px solid #667eea;padding-left:16px;margin-bottom:20px;background:#f8fafc;padding:16px;border-radius:8px;}
.scenario h3{margin-top:0;color:#667eea;}
.input-group{margin:16px 0;}
.input-group label{display:block;margin-bottom:8px;font-weight:bold;color:#374151;}
.input-group input{width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;}
.input-group input:focus{outline:none;border-color:#667eea;}
.result{padding:12px;border-radius:8px;margin-top:16px;font-weight:bold;display:none;}
.result.success{background:#d1fae5;color:#065f46;border:2px solid #10b981;}
.result.error{background:#fee2e2;color:#991b1b;border:2px solid #ef4444;}
.hipaa-badge{display:inline-block;background:#ddd6fe;color:#5b21b6;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold;margin-top:8px;}
.instructions{background:#fef3c7;padding:12px;border-left:4px solid #f59e0b;border-radius:4px;margin-bottom:20px;}
.progress{background:#e5e7eb;height:8px;border-radius:4px;margin:20px 0;overflow:hidden;}
.progress-bar{background:#667eea;height:100%;transition:width 0.3s;width:0%;}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px;}
.stat-card{background:white;padding:16px;border-radius:8px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.stat-number{font-size:32px;font-weight:bold;color:#667eea;}
.stat-label{color:#6b7280;font-size:14px;margin-top:4px;}
</style>
</head>
<body>
<div class="container">
  <h1>üõ°Ô∏è HIPAA Training Simulator</h1>
  <p class="subtitle">Complete these scenarios correctly to maintain HIPAA compliance. Errors will be logged to admin dashboard.</p>
  
  <div class="card">
    <a href="/user_dashboard"><button class="btn-secondary">‚Üê Back to Dashboard</button></a>
  </div>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-number" id="complianceScore">0</div>
      <div class="stat-label">Compliance Score</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="completed">0</div>
      <div class="stat-label">Modules Completed</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="correct">0</div>
      <div class="stat-label">Correct Answers</div>
    </div>
  </div>

  <div class="card" style="text-align:center;">
    <button class="btn-danger" onclick="resetMyTraining()" id="resetBtn">üîÑ Reset My Training Progress</button>
    <p style="color:#6b7280;font-size:12px;margin-top:8px;">This will reset your compliance score and training history</p>
  </div>

  <div class="progress">
    <div class="progress-bar" id="progressBar"></div>
  </div>

  <div class="instructions">
    <strong>‚ö†Ô∏è Instructions:</strong> Read each scenario carefully and follow the exact instructions. Any mistakes will be logged as HIPAA violations that the administrator can review in the EDR panel.
  </div>

  <!-- Scenario 1: Fax -->
  <div class="card">
    <div class="scenario">
      <h3>üì† Scenario 1: Faxing Patient Records</h3>
      <p><strong>Assignment:</strong> Dr. Martinez requested patient records for John Doe (MRN001). You need to fax the records to his office.</p>
      <p><strong>Correct Fax Number:</strong> <code style="background:#fef3c7;padding:4px 8px;border-radius:4px;">555-1234</code></p>
      <span class="hipaa-badge">HIPAA ¬ß 164.312(b)</span>
    </div>
    <div class="input-group">
      <label>Enter fax number where you will send the records:</label>
      <input type="text" id="fax-input" placeholder="555-XXXX">
    </div>
    <button class="btn-primary" onclick="submitFax()">üì§ Send Fax</button>
    <div class="result" id="fax-result"></div>
  </div>

  <!-- Scenario 2: Email -->
  <div class="card">
    <div class="scenario">
      <h3>üìß Scenario 2: Emailing Lab Results</h3>
      <p><strong>Assignment:</strong> Lab results for Jane Smith (MRN002) came back. Email them to the internal records department.</p>
      <p><strong>Correct Email:</strong> <code style="background:#fef3c7;padding:4px 8px;border-radius:4px;">records@securemed.com</code></p>
      <span class="hipaa-badge">HIPAA ¬ß 164.312(e)(1)</span>
    </div>
    <div class="input-group">
      <label>Enter email address where you will send the lab results:</label>
      <input type="email" id="email-input" placeholder="email@example.com">
    </div>
    <button class="btn-primary" onclick="submitEmail()">üì® Send Email</button>
    <div class="result" id="email-result"></div>
  </div>

  <!-- Scenario 3: USB Drive -->
  <div class="card">
    <div class="scenario">
      <h3>üíæ Scenario 3: USB Drive Request</h3>
      <p><strong>Situation:</strong> A colleague asks you to copy Robert Johnson's (MRN003) medical history to their personal USB drive for a presentation.</p>
      <p><strong>Correct Action:</strong> <strong style="color:#dc2626;">DENY this request</strong> - copying PHI to personal devices violates HIPAA</p>
      <span class="hipaa-badge">HIPAA ¬ß 164.312(a)(2)(iv)</span>
    </div>
    <div style="margin:16px 0;text-align:center;">
      <button class="btn-danger" onclick="submitUSB('DENY')" style="margin-right:10px;">‚ùå DENY Request (Correct)</button>
      <button class="btn-primary" onclick="submitUSB('ALLOW')">‚úÖ ALLOW and Copy Files</button>
    </div>
    <div class="result" id="usb-result"></div>
  </div>

  <!-- Scenario 4: Hallway Discussion -->
  <div class="card">
    <div class="scenario">
      <h3>üó£Ô∏è Scenario 4: Public Conversation</h3>
      <p><strong>Situation:</strong> A doctor asks you about Emily Davis's (MRN004) cancer diagnosis while you're both in a public hallway where visitors are present.</p>
      <p><strong>Correct Action:</strong> <strong style="color:#dc2626;">DECLINE</strong> to discuss - move to a private area first</p>
      <span class="hipaa-badge">HIPAA ¬ß 164.308(a)(5)</span>
    </div>
    <div style="margin:16px 0;text-align:center;">
      <button class="btn-danger" onclick="submitHallway('DENY')" style="margin-right:10px;">‚ùå DECLINE to Discuss Here (Correct)</button>
      <button class="btn-primary" onclick="submitHallway('DISCUSS')">‚úÖ Discuss in Hallway</button>
    </div>
    <div class="result" id="hallway-result"></div>
  </div>

  <!-- Scenario 5: Unauthorized Access -->
  <div class="card">
    <div class="scenario">
      <h3>üîê Scenario 5: Record Access</h3>
      <p><strong>Situation:</strong> You're curious about Michael Wilson's (MRN005) records because he's a celebrity, but you're NOT assigned to his care.</p>
      <p><strong>Correct Action:</strong> <strong style="color:#dc2626;">DO NOT ACCESS</strong> - only view records for patients in your care</p>
      <span class="hipaa-badge">HIPAA ¬ß 164.308(a)(3)(ii)(B)</span>
    </div>
    <div style="margin:16px 0;text-align:center;">
      <button class="btn-danger" onclick="submitAccess('DENY')" style="margin-right:10px;">‚ùå DO NOT Access (Correct)</button>
      <button class="btn-primary" onclick="submitAccess('ACCESS')">üëÄ View Records Anyway</button>
    </div>
    <div class="result" id="access-result"></div>
  </div>

</div>

<script>
let stats = {completed: 0, correct: 0, complianceScore: 0};
const totalScenarios = 5;
let currentUser = '{{ session.user }}';

// Load user's current training progress
async function loadProgress() {
  const r = await fetch('/api/training/score');
  const data = await r.json();
  stats.complianceScore = data.compliance_score;
  stats.completed = data.training_completed;
  updateDisplay();
}

function updateDisplay() {
  document.getElementById('complianceScore').textContent = stats.complianceScore + '%';
  document.getElementById('completed').textContent = stats.completed;
  document.getElementById('correct').textContent = stats.correct;
  document.getElementById('progressBar').style.width = stats.complianceScore + '%';
}

function showResult(elementId, success, message) {
  const el = document.getElementById(elementId);
  el.className = 'result ' + (success ? 'success' : 'error');
  el.textContent = message;
  el.style.display = 'block';

  if (success) stats.correct++;

  setTimeout(() => {
    el.style.display = 'none';
  }, 5000);
}

async function resetMyTraining() {
  if (!confirm('Are you sure you want to reset your training progress?\n\nThis will:\n- Reset compliance score to 0\n- Clear all completed modules\n- Remove training history')) {
    return;
  }

  const r = await fetch(`/api/training/reset/${currentUser}`, {method: 'POST'});
  const result = await r.json();

  if (r.ok) {
    alert('‚úÖ ' + result.message + '\n\nPage will reload...');
    window.location.reload();
  } else {
    alert('‚ùå Error: ' + result.error);
  }
}

async function submitFax() {
  const value = document.getElementById('fax-input').value.trim();
  if (!value) {
    alert('Please enter a fax number');
    return;
  }

  const isCorrect = value === '555-1234';
  const r = await fetch('/api/training/submit', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      scenario_type: 'fax',
      is_correct: isCorrect
    })
  });

  const result = await r.json();
  stats.complianceScore = result.new_score;
  stats.completed = result.training_completed;
  updateDisplay();

  if (isCorrect) {
    showResult('fax-result', true, `‚úÖ Correct! Faxed to approved number. Score: +${result.score_change}`);
  } else {
    showResult('fax-result', false, `‚ùå VIOLATION! Wrong fax number. Score: ${result.score_change}`);
    alert('‚ö†Ô∏è VIOLATION LOGGED TO ADMIN! You faxed to the WRONG number: ' + value);
  }
}

async function submitEmail() {
  const value = document.getElementById('email-input').value.trim();
  if (!value) {
    alert('Please enter an email address');
    return;
  }

  const isCorrect = value === 'records@securemed.com';
  const r = await fetch('/api/training/submit', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      scenario_type: 'email',
      is_correct: isCorrect
    })
  });

  const result = await r.json();
  stats.complianceScore = result.new_score;
  stats.completed = result.training_completed;
  updateDisplay();

  if (isCorrect) {
    showResult('email-result', true, `‚úÖ Correct! Sent to secure internal email. Score: +${result.score_change}`);
  } else {
    showResult('email-result', false, `‚ùå VIOLATION! Wrong email address. Score: ${result.score_change}`);
    alert('‚ö†Ô∏è VIOLATION LOGGED TO ADMIN! You emailed PHI to: ' + value);
  }
}

async function submitUSB(action) {
  const isCorrect = action === 'DENY';
  const r = await fetch('/api/training/submit', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      scenario_type: 'usb',
      is_correct: isCorrect
    })
  });

  const result = await r.json();
  stats.complianceScore = result.new_score;
  stats.completed = result.training_completed;
  updateDisplay();

  if (isCorrect) {
    showResult('usb-result', true, `‚úÖ Correct! You properly denied the request. Score: +${result.score_change}`);
  } else {
    showResult('usb-result', false, `‚ùå VIOLATION! Never copy PHI to personal devices. Score: ${result.score_change}`);
    alert('‚ö†Ô∏è VIOLATION LOGGED TO ADMIN! You copied PHI to a personal USB drive!');
  }
}

async function submitHallway(action) {
  const isCorrect = action === 'DENY';
  const r = await fetch('/api/training/submit', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      scenario_type: 'hallway',
      is_correct: isCorrect
    })
  });

  const result = await r.json();
  stats.complianceScore = result.new_score;
  stats.completed = result.training_completed;
  updateDisplay();

  if (isCorrect) {
    showResult('hallway-result', true, `‚úÖ Correct! You moved to a private area. Score: +${result.score_change}`);
  } else {
    showResult('hallway-result', false, `‚ùå VIOLATION! Never discuss PHI in public. Score: ${result.score_change}`);
    alert('‚ö†Ô∏è VIOLATION LOGGED TO ADMIN! You discussed PHI in a public hallway!');
  }
}

async function submitAccess(action) {
  const isCorrect = action === 'DENY';
  const r = await fetch('/api/training/submit', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      scenario_type: 'unauthorized_access',
      is_correct: isCorrect
    })
  });

  const result = await r.json();
  stats.complianceScore = result.new_score;
  stats.completed = result.training_completed;
  updateDisplay();

  if (isCorrect) {
    showResult('access-result', true, `‚úÖ Correct! You respected access controls. Score: +${result.score_change}`);
  } else {
    showResult('access-result', false, `‚ùå VIOLATION! Only access records for your patients. Score: ${result.score_change}`);
    alert('‚ö†Ô∏è VIOLATION LOGGED TO ADMIN! You accessed unauthorized patient records!');
  }
}

// Initialize
loadProgress();
</script>
</body>
</html>