<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SecureMed Admin Dashboard - React</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="/static/session_timeout.js" defer></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; }
.header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
.header h1 { font-size: 28px; font-weight: 700; }
.header p { opacity: 0.9; font-size: 14px; margin-top: 4px; }
.btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 14px; }
.btn-primary { background: #667eea; color: white; }
.btn-primary:hover { background: #5568d3; transform: translateY(-2px); }
.btn-success { background: #10b981; color: white; }
.btn-success:hover { background: #059669; }
.btn-danger { background: #ef4444; color: white; }
.btn-danger:hover { background: #dc2626; }
.btn-warning { background: #f59e0b; color: white; }
.btn-warning:hover { background: #d97706; }
.container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }

/* Global Search Bar */
.search-container { background: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; display: flex; gap: 12px; align-items: center; }
.search-input { flex: 1; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; transition: all 0.3s; }
.search-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
.search-btn { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
.search-btn:hover { background: #5568d3; transform: translateY(-1px); }

/* Quick Filter Buttons */
.quick-filters { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
.filter-btn { padding: 8px 16px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; color: #6b7280; }
.filter-btn:hover { border-color: #667eea; color: #667eea; }
.filter-btn.active { background: #667eea; color: white; border-color: #667eea; }

.quick-actions { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 20px; }
.stat-card { background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); padding: 20px 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); cursor: pointer; transition: all 0.3s; border-left: 5px solid #667eea; position: relative; overflow: hidden; }
.stat-card::before { content: ''; position: absolute; top: 0; right: 0; width: 100px; height: 100px; background: rgba(102, 126, 234, 0.05); border-radius: 50%; transform: translate(30%, -30%); }
.stat-card:hover { transform: translateY(-6px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.15); }
.stat-label { color: #6b7280; font-size: 13px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-number { font-size: 42px; font-weight: 800; color: #1f2937; line-height: 1; }
.card { background: white; padding: 20px 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
.card h2 { font-size: 18px; color: #1f2937; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb; font-weight: 700; }
table { width: 100%; border-collapse: collapse; margin-top: 16px; }
th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
th { background: #f9fafb; font-weight: 600; color: #374151; }
tr:hover { background: #f9fafb; }
.badge { padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; }
.badge-pending { background: #fef3c7; color: #92400e; }
.badge-completed { background: #d1fae5; color: #065f46; }
.badge-failed { background: #fee2e2; color: #991b1b; }
.loading { text-align: center; padding: 40px; color: #6b7280; }
.empty-state { text-align: center; padding: 40px; color: #6b7280; }
.hidden { display: none; }

/* Loading Spinner Styles */
.spinner-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; }
.spinner { width: 50px; height: 50px; border: 4px solid #e5e7eb; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.spinner-text { color: #6b7280; font-size: 16px; font-weight: 500; }

/* Loading Overlay */
.loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; }
.loading-overlay .spinner-container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); min-height: auto; }
</style>
</head>
<body>
<div id="root"></div>

{% raw %}
<script type="text/babel">
const { useState, useEffect, useCallback } = React;

const LoadingSpinner = ({ message = "Loading..." }) => (
  <div className="spinner-container">
    <div className="spinner"></div>
    <div className="spinner-text">{message}</div>
  </div>
);

const StatCard = ({ label, value, onClick }) => (
  <div className="stat-card" onClick={onClick}>
    <div className="stat-label">{label}</div>
    <div className="stat-number">{value}</div>
  </div>
);

const DataTable = ({ columns, data, renderRow }) => {
  if (!data || data.length === 0) {
    return <div className="empty-state">No data available</div>;
  }

  return (
    <table>
      <thead>
        <tr>
          {columns.map((col, idx) => (
            <th key={idx}>{col}</th>
          ))}
        </tr>
      </thead>
      <tbody>
        {data.map((row, idx) => renderRow(row, idx))}
      </tbody>
    </table>
  );
};

const Dashboard = () => {
  const [stats, setStats] = useState({ patients: 0, assignments: 0, violations: 0 });
  const [assignments, setAssignments] = useState([]);
  const [patients, setPatients] = useState([]);
  const [loading, setLoading] = useState(true);
  const [actionLoading, setActionLoading] = useState(false);

  const loadStats = useCallback(async () => {
    try {
      const [patientsRes, assignmentsRes, violationsRes] = await Promise.all([
        fetch('/api/patients').then(r => r.json()),
        fetch('/api/assignments').then(r => r.json()),
        fetch('/api/edr_data').then(r => r.json())
      ]);

      const pendingCount = assignmentsRes.filter(a => a.status === 'Pending').length;
      const violationCount = violationsRes.filter(v => v.status === 'Unresolved' && v.source !== 'scanner').length;

      setStats({
        patients: patientsRes.length,
        assignments: pendingCount,
        violations: violationCount
      });
    } catch (error) {
      console.error('Error loading stats:', error);
    }
  }, []);

  const loadAssignments = useCallback(async () => {
    try {
      const data = await fetch('/api/assignments').then(r => r.json());
      setAssignments(data);
    } catch (error) {
      console.error('Error loading assignments:', error);
    }
  }, []);

  const loadPatients = useCallback(async () => {
    try {
      const data = await fetch('/api/patients').then(r => r.json());
      setPatients(data);
    } catch (error) {
      console.error('Error loading patients:', error);
    }
  }, []);

  const generateAssignments = async () => {
    setActionLoading(true);
    try {
      const response = await fetch('/api/assignments/generate', { method: 'POST' });
      const result = await response.json();
      alert(result.message || 'Assignments generated!');
      await Promise.all([loadStats(), loadAssignments()]);
    } catch (error) {
      alert('Error generating assignments: ' + error);
    } finally {
      setActionLoading(false);
    }
  };

  const seedVulnerabilities = async () => {
    setActionLoading(true);
    try {
      const response = await fetch('/api/seed_vulnerabilities', { method: 'POST' });
      const result = await response.json();
      alert(result.message);
      await loadStats();
    } catch (error) {
      alert('Error seeding vulnerabilities: ' + error);
    } finally {
      setActionLoading(false);
    }
  };

  const quickSetup = async () => {
    if (!confirm('‚ö° QUICK SETUP\n\nThis will generate:\n- 5 sample patients\n- Task assignments for nurses\n- Vulnerability scenarios\n- HIPAA compliance violations\n\nPerfect for starting a demo!\n\nContinue?')) {
      return;
    }
    setActionLoading(true);
    try {
      // Call all setup endpoints sequentially
      await fetch('/api/seed_patients', { method: 'POST' });
      await fetch('/api/assignments/generate', { method: 'POST' });
      await fetch('/api/seed_vulnerabilities', { method: 'POST' });
      await fetch('/api/seed_hipaa_compliance', { method: 'POST' });

      alert('‚úÖ Quick setup complete!\n\n- 5 patients created\n- Assignments generated\n- Vulnerabilities seeded\n- HIPAA violations added\n\nReady for demo!');
      window.location.reload();
    } catch (error) {
      alert('Error during quick setup: ' + error);
    } finally {
      setActionLoading(false);
    }
  };

  const seedHIPAACompliance = async () => {
    setActionLoading(true);
    try {
      const response = await fetch('/api/seed_hipaa_compliance', { method: 'POST' });
      const result = await response.json();
      if (response.ok) {
        alert(`${result.message}\n\nCategories:\n- Administrative: ${result.categories.Administrative}\n- Physical: ${result.categories.Physical}\n- Technical: ${result.categories.Technical}\n- Privacy: ${result.categories.Privacy}\n- Breach: ${result.categories.Breach}\n- Organizational: ${result.categories.Organizational}\n- Specific: ${result.categories.Specific}`);
        await loadStats();
      } else {
        alert('Error: ' + result.error);
      }
    } catch (error) {
      alert('Error seeding HIPAA compliance violations: ' + error);
    } finally {
      setActionLoading(false);
    }
  };

  const generateReport = async () => {
    setActionLoading(true);
    try {
      const response = await fetch('/api/generate_report', { method: 'POST' });
      const result = await response.json();

      if (response.ok) {
        alert(`${result.message}\n${result.count} HIPAA violations included in report`);
        window.location.href = '/api/reports/download';
      } else {
        alert('Error: ' + result.error);
      }
    } catch (error) {
      alert('Error generating report: ' + error);
    } finally {
      setActionLoading(false);
    }
  };

  const resetDemo = async () => {
    if (!confirm('‚ö†Ô∏è WARNING: This will DELETE ALL data and reset to demo state!\n\nAre you sure? This is meant for presentations.')) {
      return;
    }
    setActionLoading(true);
    try {
      const response = await fetch('/api/reset_demo', { method: 'POST' });
      const result = await response.json();
      if (response.ok) {
        alert('‚úÖ ' + result.message + '\n\nPage will reload...');
        window.location.reload();
      } else {
        alert('Error: ' + result.error);
      }
    } catch (error) {
      alert('Error resetting demo: ' + error);
    } finally {
      setActionLoading(false);
    }
  };

  const simulateBreach = async () => {
    const breachTypes = [
      { value: 'ransomware', label: 'Ransomware Attack' },
      { value: 'insider_threat', label: 'Insider Data Theft' },
      { value: 'phishing', label: 'Phishing Attack' },
      { value: 'database_exposure', label: 'Database Exposed to Internet' },
      { value: 'physical_theft', label: 'Laptop Theft (Unencrypted PHI)' }
    ];

    const choice = prompt(
      'üö® DATA BREACH SIMULATION\n\nSelect breach type (1-5):\n\n' +
      '1. Ransomware Attack\n' +
      '2. Insider Data Theft\n' +
      '3. Phishing Attack\n' +
      '4. Database Exposed to Internet\n' +
      '5. Laptop Theft (Unencrypted PHI)\n\n' +
      'Enter number (1-5):'
    );

    if (!choice || choice < 1 || choice > 5) {
      return;
    }

    const breachType = breachTypes[parseInt(choice) - 1].value;
    const affectedRecords = prompt('How many patient records affected?', '100');

    if (!affectedRecords) {
      return;
    }

    setActionLoading(true);
    try {
      const response = await fetch('/api/breach/simulate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          breach_type: breachType,
          affected_records: parseInt(affectedRecords)
        })
      });
      const result = await response.json();
      if (response.ok) {
        alert(
          'üö® ' + result.message + '\n\n' +
          'Type: ' + result.breach_details.type + '\n' +
          'Severity: ' + result.breach_details.severity + '\n\n' +
          'Check EDR panel for details!'
        );
        window.location.reload();
      } else {
        alert('Error: ' + result.error);
      }
    } catch (error) {
      alert('Error simulating breach: ' + error);
    } finally {
      setActionLoading(false);
    }
  };

  const scrollToSection = (sectionId) => {
    const element = document.getElementById(sectionId);
    if (element) {
      element.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  };

  useEffect(() => {
    const loadAllData = async () => {
      setLoading(true);
      await Promise.all([loadStats(), loadAssignments(), loadPatients()]);
      setLoading(false);
    };
    loadAllData();
  }, [loadStats, loadAssignments, loadPatients]);

  if (loading) {
    return <LoadingSpinner message="Loading dashboard data..." />;
  }

  return (
    <>
      {actionLoading && (
        <div className="loading-overlay">
          <LoadingSpinner message="Processing..." />
        </div>
      )}
      <div className="header">
        <div className="header-content">
          <div>
            <h1>üõ°Ô∏è SecureMed Admin Dashboard</h1>
            <p>System Overview & Management</p>
          </div>
          <button className="btn btn-danger" onClick={() => window.location.href = '/logout'}>
            Logout
          </button>
        </div>
      </div>

      <div className="container">
        {/* Global Search Bar */}
        <div className="search-container">
          <input
            type="text"
            className="search-input"
            placeholder="üîç Search patients, assignments, violations..."
            onKeyPress={(e) => e.key === 'Enter' && alert('Search functionality - would filter all tables')}
          />
          <button className="search-btn">Search</button>
        </div>

        <div className="quick-actions">
          <button className="btn btn-primary" onClick={() => window.location.href = '/dashboard'}>
            üìä Dashboard
          </button>
          <button className="btn btn-primary" onClick={() => window.location.href = '/edr'}>
            üß† EDR Panel
          </button>
          <button className="btn btn-primary" onClick={() => window.location.href = '/audit_trail'}>
            üìä Audit Trail
          </button>
          <button className="btn btn-primary" onClick={generateReport}>
            üìã HIPAA Report
          </button>
          <div style={{borderLeft: '2px solid #e5e7eb', height: '40px', margin: '0 8px'}}></div>
          <button className="btn btn-success" onClick={quickSetup}>
            ‚ö° Quick Setup (Patients + Demo Data)
          </button>
          <button className="btn btn-danger" onClick={simulateBreach} style={{background: '#dc2626'}}>
            üö® Simulate Breach
          </button>
          <div style={{borderLeft: '2px solid #e5e7eb', height: '40px', margin: '0 8px'}}></div>
          <button className="btn btn-danger" onClick={resetDemo} style={{marginLeft: 'auto'}}>
            üîÑ Full Demo Reset
          </button>
        </div>

        <div className="stats-grid">
          <StatCard 
            label="Total Patients" 
            value={stats.patients} 
            onClick={() => scrollToSection('patients-section')}
          />
          <StatCard 
            label="Pending Assignments" 
            value={stats.assignments} 
            onClick={() => scrollToSection('assignments-section')}
          />
          <StatCard 
            label="Active Violations" 
            value={stats.violations} 
            onClick={() => scrollToSection('violations-section')}
          />
        </div>

        <div className="card" id="assignments-section">
          <h2>üìÑ All Assignments</h2>
          <button className="btn btn-primary" onClick={loadAssignments}>
            üîÑ Refresh
          </button>
          
          <DataTable
            columns={['ID', 'Type', 'Description', 'Assigned To', 'Status', 'Created']}
            data={assignments}
            renderRow={(a) => (
              <tr key={a.id}>
                <td>{a.id}</td>
                <td><strong>{a.task_type.toUpperCase()}</strong></td>
                <td>{a.description}</td>
                <td>{a.assigned_to}</td>
                <td>
                  <span className={`badge badge-${a.status.toLowerCase()}`}>
                    {a.status}
                  </span>
                </td>
                <td>{a.created_at}</td>
              </tr>
            )}
          />
        </div>

        <div className="card" id="patients-section">
          <h2>üë• All Patients</h2>
          <button className="btn btn-primary" onClick={loadPatients}>
            üîÑ Refresh
          </button>
          
          <DataTable
            columns={['MRN', 'Name', 'DOB', 'Email', 'Phone', 'Address', 'Added By', 'Date Added']}
            data={patients}
            renderRow={(p) => (
              <tr key={p.id}>
                <td><strong>{p.mrn}</strong></td>
                <td>{p.first_name} {p.last_name}</td>
                <td>{p.date_of_birth}</td>
                <td>{p.email || 'N/A'}</td>
                <td>{p.phone || 'N/A'}</td>
                <td>{p.address || 'N/A'}</td>
                <td>{p.created_by}</td>
                <td>{p.created_at}</td>
              </tr>
            )}
          />
        </div>

        <div className="card" id="violations-section">
          <h2>‚ö†Ô∏è Active Violations</h2>
          <button className="btn btn-primary" onClick={() => window.location.href='/edr'}>
            üîó View Full EDR Panel
          </button>

          <table style={{marginTop: '16px'}}>
            <thead>
              <tr>
                <th>Type</th>
                <th>Severity</th>
                <th>Nurse</th>
                <th>Timestamp</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colSpan="5" style={{textAlign: 'center', padding: '20px', color: '#6b7280'}}>
                  {stats.violations > 0 ? `${stats.violations} violations found - View in EDR Panel` : 'No active violations'}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </>
  );
};

ReactDOM.render(<Dashboard />, document.getElementById('root'));
</script>
{% endraw %}
</body>
</html>
